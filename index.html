<!DOCTYPE html>
<html lang="en">
<meta charset="UTF-8">

<head>
    <title>Offline Spy ğŸ•µï¸</title>
    <style>
        body {}

        #game-window {
            display: none;
            border: 1px solid black;
            padding: 5px;
        }

        #start-form {
            padding: 5px;
        }

        #locations-list {
            list-style-type: none;
        }
    </style>
    <script type="text/javascript">
        rooms = ["ğŸ›«ğŸ’º Airplane",
            "ğŸ¦ğŸ’° Bank",
            "ğŸ›³ğŸŒŠ Cruise Ship",
            "âš½ï¸ğŸŸ Football Stadium",
            "ğŸªğŸ›’ Grocery Store",
            "ğŸ¥ğŸ§‘â€âš•ï¸ Hospital",
            "ğŸ¨ğŸ› Hotel",
            "ğŸğŸ¿ Cinema",
            "ğŸ›ğŸ–¼ Museum",
            "ğŸ¤ğŸ“® Post Office",
            "ğŸ½ğŸ‘©â€ğŸ³ Restaurant",
            "ğŸŸğŸ¸ Rock Concert",
            "ğŸš„ğŸ›¤ Train",
            "ğŸ«ğŸ“ University",
        ];

        validations = ["ğŸ˜€",
            "â­ï¸",
            "ğŸª",
            "ğŸ•",
            "ğŸ“",
            "ğŸ¥",
            "ğŸ©",
            "ğŸ¦",
            "âš½ï¸",
            "ğŸ·",
            "ğŸ§©",
            "ğŸ”‘",
            "ğŸ¶",
            "ğŸ¦œ",
            "ğŸµ",
            "ğŸ¬"]

        function startGame() {
            /* Get the Game params */
            var seed = document.getElementById("seed").value.toUpperCase();
            var iterationField = document.getElementById("iteration");
            var player = document.getElementById("player").value;
            var totalPlayers = document.getElementById("total-players").value;

            /* Validate the params */
            while (seed.length < 4) {
                seed += "A";
            }

            /* Generate randomness */
            var randomNumber = getRNG(seed, iterationField.value, totalPlayers);
            var signature = getValidation(randomNumber);
            var isSpy = isPsy(randomNumber, player, totalPlayers);

            var room = "â“";
            if (!isSpy) {
                room = getRoom(randomNumber);
                document.getElementById("spy-block").style.display = "none";
                document.getElementById("not-spy-block").style.display = "block";
            } else {
                document.getElementById("spy-block").style.display = "block";
                document.getElementById("not-spy-block").style.display = "none";
            }


            /* Setup the Game Window */
            document.getElementById("signature").innerHTML = signature;
            document.getElementById("playerid").innerHTML = player;
            document.getElementById("room").innerHTML = room;
            document.getElementById("game-window").style.display = "block";
            iterationField.value = iterationField.value * 1 + 1;

        }

        function getRNG(seed, iteration, totalPlayers) {
            var startDate = 0;
            for (let i = 0; i < seed.length; i++) {
                var charCode = seed.charCodeAt(i) + iteration + totalPlayers;
                startDate += charCode * (3 ** i);
            }

            var modulo = 65536;
            startDate %= modulo;
            var lfsr = startDate;
            var period = 0;

            do {
                lfsr ^= lfsr >> 7;
                lfsr ^= lfsr << 9;
                lfsr ^= lfsr >> 13;
                ++period;

                if (period > 1000000000) {
                    break;
                }
            }
            while ((lfsr % modulo) != startDate);

            return period;
        }

        function getValidation(seed) {
            var seed1 = seed;
            var seed2 = seed ^ (seed1 >> 1);
            var seed3 = seed ^ (seed2 >> 1);
            return validations[seed1 % validations.length] + validations[seed2 % validations.length] + validations[seed3 % validations.length];
        }

        function getRoom(seedNumber) {
            return rooms[seedNumber % rooms.length];
        }

        function isPsy(seedNumber, playerId, totalPlayers) {
            var spy = (seedNumber % totalPlayers) + 1;
            return playerId == spy;
        }

        function showHide(elementId) {
            var elem = document.getElementById(elementId);
            if(elem.style.display === 'none') {
                elem.style.display = 'block';
            } else {
                elem.style.display = 'none';
            }
        }

    </script>
</head>

<body>

    <h1>Offline Spy</h1>

    <div id="game-window">
        <div>
            Signature: <span id="signature"></span>
        </div>
        <br>
        <div>
            ğŸ‘¤ Player <strong>#<span id="playerid"></span></strong>
        </div>
        <br>
        <div id="secret-block">
            <div id="spy-block">
                ğŸ•µ You <strong>are</strong> the spy
            </div>
            <div id="not-spy-block">
                ğŸ˜‡ You are <strong>not</strong> the spy
            </div>
            <div>
                Room: <span id="room"></span>
            </div>
        </div>
        <div>
            <button onclick="showHide('secret-block');">ğŸ‘“ Show/Hide</button>
        </div>
    </div>

    <hr>

    <div id="start-form">
        <label>ğŸ² Seed</label>&nbsp;<input id="seed" value="ABCD"><br>
        <label>ğŸ”¢ Iteration</label>&nbsp;<input type="number" id="iteration" value="1" min="1"><br>
        <label>ğŸ‘¥ Number of players</label>&nbsp;<input type="number" id="total-players" value="3" min="3"><br>
        <br>
        <label>ğŸ‘¤ Player #</label>&nbsp;<input type="number" id="player" value="1" min="1"><br>
        <button onclick="startGame();">ğŸ Start New Game</button>
    </div>

    <hr>

    <div>
        <span>Locations</span>
        <ul id="locations-list">
        </ul>
    </div>

    <hr>

    <div class="footer">
        <div><a href="https://github.com/VeryBadFrags/offline-spy" target="_blank" rel="noopener noreferrer">Source
                code</a></div>
        <div>Version: 0.1.1</div>
    </div>

    <script>
        /* Init seed */
        var characters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
        var charactersLength = characters.length;
        var newSeed = "";
        for (var i = 0; i < 4; i++) {
            newSeed += characters.charAt(Math.floor(Math.random() * charactersLength));
        }
        document.getElementById("seed").value = newSeed;

        /* Show the list of Locations */
        var locationsList = document.getElementById("locations-list");
        for (var i = 0; i < rooms.length; i++) {
            var room = rooms[i];
            var li = document.createElement("li");
            li.innerHTML = room;
            locationsList.appendChild(li);
        }
    </script>

</body>

</html>
