<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
    <title>Offline Spy</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🕵️</text></svg>">
    <style>
        body {
            font-size: 18px;
            text-align: center;
            font-family: Arial, Helvetica, sans-serif;
        }

        h1 {
            margin-bottom: 5px;
        }

        h3 {
            margin-top: 0;
        }

        .card {
            border: 1px solid #90A4AE;
            border-radius: 5px;
            box-shadow: 1px 1px 4px #E0E0E0;
            display: inline-block;
            min-width: 300px;
            margin: 12px 12px;
            padding: 16px;
            text-align: left;
            vertical-align: top;
        }

        .list {
            list-style-type: none;
            font-size: 1.1em;
        }

        .alert {
            border: 1px solid red;
            color: red;
        }

        .button {
            background-color: #E0F2F1;
            border: 1px solid #424242;
            border-radius: 5px;
            box-shadow: 0px 0px 1px #9E9E9E;
            color: black;
            width: 100%;
            margin-top: 15px;
            margin-bottom: 10px;
            padding: 15px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 0.9em;
        }

        .button:hover {
            background-color: #B2DFDB;
            box-shadow: 0px 0px 3px #9E9E9E;
        }

        .larger-text {
            font-size: 1.3em;
        }

        input,
        select {
            width: 100%;
            border: 2px solid #B2EBF2;
            border-radius: 4px;
            box-shadow: 0px 0px 1px #9E9E9E;
            padding: 10px 12px;
            margin: 8px 0;
            margin-top: 0;
            margin-bottom: 15px;
            box-sizing: border-box;
            font-size: 0.9em;
        }

        .custom-select {
            width: 100%;
        }
    </style>

    <script type="text/javascript">
        locationsList = ["✈️💺 Airplane",
            "🏦💰 Bank",
            "🎰💵 Casino",
            "🦸🦹 Cosplay Convention",
            "🛳🌊 Cruise Ship",
            "🚒🧑‍🚒 Fire Station",
            "⚽️🏟 Football Stadium",
            "🌳🏕 Forest Camp",
            "🏪🛒 Grocery Store",
            "🏥🧑‍⚕️ Hospital",
            "🏨🛏 Hotel",
            "🎞🍿 Cinema",
            "🏛🖼 Museum",
            "⛰🥾 Mountain Hike",
            "🏤📮 Post Office",
            "🚔👮‍♂️ Police Station",
            "🍽👩‍🍳 Restaurant",
            "🏟🎸 Rock Concert",
            "🚄🛤 High-speed Train",
            "🏫🎓 University",
        ];

        validations = ["😀",
            "⭐️",
            "🍪",
            "🍕",
            "🍓",
            "🥐",
            "🍩",
            "🍦",
            "⚽️",
            "🎷",
            "🧩",
            "🔑",
            "🐶",
            "🦜",
            "🐵",
            "🐬"];

        players = [
            "🧑‍🚀 Astronaut",
            "🧑‍🌾 Farmer",
            "💂 Guard",
            "🧑‍⚖️ Judge",
            "🧑‍🔧 Mechanic",
            "🧑‍🔬 Scientist",
            "🧑‍🎤 Singer",
            "🧑‍🎓 Student",
            "🧑‍🏫 Teacher",
            "👷 Worker",
        ];

        function startGame() {
            resetErrors();

            /* Get the Game params */
            var seed = document.getElementById("seed").value.toUpperCase();
            var iterationField = document.getElementById("iteration");
            var playerElement = document.getElementById("player");
            var player = playerElement.options[playerElement.selectedIndex].value;
            var totalPlayers = getTotalNumberOfPlayers();

            /* Validate the params */
            while (seed.length < 4) {
                seed += "A";
            }
            if (player + 1 > totalPlayers) {
                var errorBox = document.getElementById("error");
                errorBox.innerHTML = "Error: 👤 > 👥 <br> Player # greater than total number of players"
                errorBox.style.display = "block";
                return;
            }

            /* Generate randomness */
            var randomNumber = getRNG(seed, iterationField.value, totalPlayers);
            var signature = getFingerprint(randomNumber);
            var isSpy = isPsy(randomNumber, player, totalPlayers);
            var firstPlayer = getFirstPlayer(randomNumber, player, totalPlayers);

            var locationName = "❓";
            if (!isSpy) {
                locationName = getLocation(randomNumber);
                document.getElementById("spyBlock").style.display = "none";
                document.getElementById("innocentBlock").style.display = "block";
            } else {
                document.getElementById("spyBlock").style.display = "block";
                document.getElementById("innocentBlock").style.display = "none";
            }

            /* Setup the Game Window */
            document.getElementById("fingerprint").innerHTML = signature;
            document.getElementById("playerid").innerHTML = players[player];
            document.getElementById("location").innerHTML = locationName;
            document.getElementById("firstPlayer").innerHTML = players[firstPlayer];
            iterationField.value = iterationField.value * 1 + 1;

            document.getElementById("secretBlock").style.display = "block"
            document.getElementById("gameWindow").style.display = "inline-block";
            window.scrollTo(0, 0);
        }

        function resetErrors() {
            var errorBox = document.getElementById("error");
            errorBox.style.display = "none";
            errorBox.innerHTML = "";
        }

        /* Pseudo-LFSR, it just needs to be fast and unpredictable */
        function getRNG(seed, iteration, totalPlayers) {
            var startDate = 0;
            for (let i = 0; i < seed.length; i++) {
                var charCode = seed.charCodeAt(i) + iteration + totalPlayers;
                startDate += charCode * (3 ** i);
            }

            var modulo = 65536;
            startDate %= modulo;
            var lfsr = startDate;
            var period = 0;

            do {
                lfsr ^= lfsr >> 7;
                lfsr ^= lfsr << 9;
                lfsr ^= lfsr >> 13;
                ++period;

                if (period > 1000000000) {
                    break;
                }
            }
            while ((lfsr % modulo) != startDate);

            return period;
        }

        /* Generate a 3-emoji signature to confirm that players are on the same game */
        function getFingerprint(seedNumber) {
            var seed1 = seedNumber;
            var seed2 = seedNumber ^ (seed1 >> 1);
            var seed3 = seedNumber ^ (seed2 >> 1);
            return validations[seed1 % validations.length] + validations[seed2 % validations.length] + validations[seed3 % validations.length];
        }

        function getLocation(seedNumber) {
            return locationsList[seedNumber % locationsList.length];
        }

        function isPsy(seedNumber, playerId, totalPlayers) {
            var spy = (seedNumber % totalPlayers);
            return playerId == spy;
        }

        function getFirstPlayer(seedNumber, playerId, totalPlayers) {
            return ((seedNumber >> 1) % totalPlayers);
        }

        function showHide(elementId) {
            var elem = document.getElementById(elementId);
            if (elem.style.display === 'none') {
                elem.style.display = 'block';
            } else {
                elem.style.display = 'none';
            }
        }

        function getTotalNumberOfPlayers() {
            return document.getElementById("total-players").value;
        }

        function removeOptions(selectElement) {
            for (var i = selectElement.options.length - 1; i >= 0; i--) {
                selectElement.remove(i);
            }
        }

    </script>
</head>

<body>

    <h1>Offline Spy</h1>

    <div id="error" class="card alert" style="display: none;"></div>

    <!-- Game Window -->
    <div id="gameWindow" class="card" style="display: none;">
        <div>
            Fingerprint <span id="fingerprint" class="larger-text"></span>
        </div>
        <br>
        <div>
            <strong id="playerid"></strong>
        </div>
        <br>
        <div>
            🔍 First question: <span id="firstPlayer"></span>
        </div>
        <br>
        <div>
            <button class="button" onclick="showHide('secretBlock');">👓 Show/Hide</button>
        </div>
        <div id="secretBlock">
            <div id="spyBlock">
                You <strong>are</strong> the spy 🕵
            </div>
            <div id="innocentBlock">
                You are <strong>not</strong> the spy 😇
            </div>
            <div>
                Location: <span id="location"></span>
            </div>
        </div>
    </div>

    <!-- List of Locations -->
    <div class="card">
        <h3>Locations</h3>
        <ul id="locationsList" class="list">
        </ul>
    </div>

    <!-- Game Settings -->
    <div id="settings" class="card">
        <div>
            <h3>⚙️ Settings</h3>
        </div>
        <label for="seed">🎲 Code</label><input type="text" id="seed" value="ABCD" autocomplete="off"><br>
        <label for="iteration">🔢 Round</label><input type="number" id="iteration" value="1" min="1" autocomplete="off">
        <br>
        <label for="total-players">👥 Total players</label><input type="number" id="total-players" value="3" min="3"
            max="10" oninput="setPlayersList();" autocomplete="off">
        <br>
        <label for="player">👤 Player (must be unique)</label>
        <div class="custom-select">
            <select name="player" id="player">
            </select>
        </div>
        <button onclick="startGame();" class="button">🏁 Start New Game</button>
    </div>

    <hr>

    <div class="footer">
        <div>Download this page and play anywhere</div>
        <div><a href="https://github.com/VeryBadFrags/offline-spy" target="_blank" rel="noopener noreferrer">Source
                code & instructions</a></div>
        <br>
        <div><a href="https://www.buymeacoffee.com/verybadfrags" target="_blank" rel="noopener noreferrer">Like this
                project?</a>
            <script type="text/javascript" src="https://cdnjs.buymeacoffee.com/1.0.0/button.prod.min.js"
                data-name="bmc-button" data-slug="verybadfrags" data-color="#79D6B5" data-emoji="" data-font="Cookie"
                data-text="Buy me a coffee" data-outline-color="#000" data-font-color="#fff"
                data-coffee-color="#fd0"></script>
        </div>
        <br>
        <div>Version: 0.3.0</div>
    </div>

    <script>
        /* Init seed */
        var characters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
        var charactersLength = characters.length;
        var newSeed = "";
        for (var i = 0; i < 4; i++) {
            newSeed += characters.charAt(Math.floor(Math.random() * charactersLength));
        }
        document.getElementById("seed").value = newSeed;

        /* Show the list of Locations */
        var locationsListElement = document.getElementById("locationsList");
        for (var i = 0; i < locationsList.length; i++) {
            var locationName = locationsList[i];
            var li = document.createElement("li");
            li.innerHTML = locationName;
            locationsListElement.appendChild(li);
        }

        playerListElement = document.getElementById("player");
        function setPlayersList() {
            removeOptions(playerListElement);
            var totalPlayers = getTotalNumberOfPlayers();
            for (var i = 0; i < players.length && i < totalPlayers; i++) {
                var opt = document.createElement('option');
                opt.value = i;
                opt.innerHTML = players[i];
                playerListElement.appendChild(opt);
            }
        }

        setPlayersList();
    </script>

</body>

</html>
