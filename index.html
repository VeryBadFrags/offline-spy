<!DOCTYPE html>
<html lang="en">
<meta charset="UTF-8">

<head>
    <title>Offline Spy</title>
    <style>
        #gameWindow {
            display: none;
            border: 1px solid black;
            padding: 5px;
        }

        #startForm {
            padding: 5px;
        }

        #locationsList {
            list-style-type: none;
        }
    </style>
    <script type="text/javascript">
        rooms = ["🛫💺 Airplane",
            "🏦💰 Bank",
            "🛳🌊 Cruise Ship",
            "⚽️🏟 Football Stadium",
            "🏪🛒 Grocery Store",
            "🏥🧑‍⚕️ Hospital",
            "🏨🛏 Hotel",
            "🎞🍿 Cinema",
            "🏛🖼 Museum",
            "🏤📮 Post Office",
            "🍽👩‍🍳 Restaurant",
            "🏟🎸 Rock Concert",
            "🚄🛤 Train",
            "🏫🎓 University",
        ];

        validations = ["😀",
            "⭐️",
            "🍪",
            "🍕",
            "🍓",
            "🥐",
            "🍩",
            "🍦",
            "⚽️",
            "🎷",
            "🧩",
            "🔑",
            "🐶",
            "🦜",
            "🐵",
            "🐬"]

        function startGame() {
            /* Get the Game params */
            var seed = document.getElementById("seed").value.toUpperCase();
            var iterationField = document.getElementById("iteration");
            var player = document.getElementById("player").value;
            var totalPlayers = document.getElementById("total-players").value;

            /* Validate the params */
            while (seed.length < 4) {
                seed += "A";
            }

            /* Generate randomness */
            var randomNumber = getRNG(seed, iterationField.value, totalPlayers);
            var signature = getValidation(randomNumber);
            var isSpy = isPsy(randomNumber, player, totalPlayers);
            var firstPlayer = getFirstPlayer(randomNumber, player, totalPlayers);

            var room = "❓";
            if (!isSpy) {
                room = getRoom(randomNumber);
                document.getElementById("spyBlock").style.display = "none";
                document.getElementById("innocentBlock").style.display = "block";
            } else {
                document.getElementById("spyBlock").style.display = "block";
                document.getElementById("innocentBlock").style.display = "none";
            }


            /* Setup the Game Window */
            document.getElementById("signature").innerHTML = signature;
            document.getElementById("playerid").innerHTML = player;
            document.getElementById("room").innerHTML = room;
            document.getElementById("firstPlayer").innerHTML = '#' + firstPlayer;
            iterationField.value = iterationField.value * 1 + 1;

            document.getElementById("secretBlock").style.display = "block"
            document.getElementById("gameWindow").style.display = "block";
        }

        function getRNG(seed, iteration, totalPlayers) {
            var startDate = 0;
            for (let i = 0; i < seed.length; i++) {
                var charCode = seed.charCodeAt(i) + iteration + totalPlayers;
                startDate += charCode * (3 ** i);
            }

            var modulo = 65536;
            startDate %= modulo;
            var lfsr = startDate;
            var period = 0;

            do {
                lfsr ^= lfsr >> 7;
                lfsr ^= lfsr << 9;
                lfsr ^= lfsr >> 13;
                ++period;

                if (period > 1000000000) {
                    break;
                }
            }
            while ((lfsr % modulo) != startDate);

            return period;
        }

        function getValidation(seed) {
            var seed1 = seed;
            var seed2 = seed ^ (seed1 >> 1);
            var seed3 = seed ^ (seed2 >> 1);
            return validations[seed1 % validations.length] + validations[seed2 % validations.length] + validations[seed3 % validations.length];
        }

        function getRoom(seedNumber) {
            return rooms[seedNumber % rooms.length];
        }

        function isPsy(seedNumber, playerId, totalPlayers) {
            var spy = (seedNumber % totalPlayers) + 1;
            return playerId == spy;
        }

        function getFirstPlayer(seedNumber, playerId, totalPlayers) {
            return ((seedNumber >> 1) % totalPlayers) + 1;
        }

        function showHide(elementId) {
            var elem = document.getElementById(elementId);
            if (elem.style.display === 'none') {
                elem.style.display = 'block';
            } else {
                elem.style.display = 'none';
            }
        }

    </script>
</head>

<body>

    <h1>Offline Spy</h1>

    <div id="gameWindow">
        <div>
            Signature: <span id="signature"></span>
        </div>
        <br>
        <div>
            👤 Player <strong>#<span id="playerid"></span></strong>
        </div>
        <br>
        <div>
            🔍 First question: <strong id="firstPlayer"></strong>
        </div>
        <br>
        <div>
            <button onclick="showHide('secretBlock');">👓 Show/Hide</button>
        </div>
        <div id="secretBlock">
            <div id="spyBlock">
                You <strong>are</strong> the spy 🕵
            </div>
            <div id="innocentBlock">
                You are <strong>not</strong> the spy 😇
            </div>
            <div>
                Room: <span id="room"></span>
            </div>
        </div>
    </div>

    <hr>

    <div id="startForm">
        <label>🎲 Seed</label>&nbsp;<input id="seed" value="ABCD"><br>
        <label>🔢 Iteration</label>&nbsp;<input type="number" id="iteration" value="1" min="1"><br>
        <label>👥 Number of players</label>&nbsp;<input type="number" id="total-players" value="3" min="3"><br>
        <br>
        <label>👤 Player #</label>&nbsp;<input type="number" id="player" value="1" min="1"><br>
        <button onclick="startGame();">🏁 Start New Game</button>
    </div>

    <hr>

    <div>
        <span>Locations</span>
        <ul id="locationsList">
        </ul>
    </div>

    <hr>

    <div class="footer">
        <div><a href="https://github.com/VeryBadFrags/offline-spy" target="_blank" rel="noopener noreferrer">Source
                code</a></div>
        <div>Version: 0.1.1</div>
    </div>

    <script>
        /* Init seed */
        var characters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
        var charactersLength = characters.length;
        var newSeed = "";
        for (var i = 0; i < 4; i++) {
            newSeed += characters.charAt(Math.floor(Math.random() * charactersLength));
        }
        document.getElementById("seed").value = newSeed;

        /* Show the list of Locations */
        var locationsList = document.getElementById("locationsList");
        for (var i = 0; i < rooms.length; i++) {
            var room = rooms[i];
            var li = document.createElement("li");
            li.innerHTML = room;
            locationsList.appendChild(li);
        }
    </script>

</body>

</html>
