<!DOCTYPE html>
<html lang="en">
<meta charset="UTF-8">

<head>
    <title>Offline Spy</title>
    <style>
        .card {
            border: 1px solid #B2EBF2;
            border-radius: 5px;
            box-shadow: 1px 1px 4px #cccccc;
            display: inline-block;
            min-width: 300px;
            margin-bottom: 20px;
            padding: 10px;
        }

        .list {
            list-style-type: none;
        }

        .alert {
            border: 1px solid red;
            padding: 5px;
            color: red;
        }

        .button {
            border: none;
            color: black;
            background-color: #80CBC4;
            box-shadow: 1px 1px 4px #9E9E9E;
            width: 100%;
            margin-top: 10px;
            padding: 15px 32px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
        }

        .button:hover {
            background-color: #4DB6AC;
            box-shadow: 1px 1px 5px #757575;
        }
    </style>
    <script type="text/javascript">
        locationsList = ["ğŸ›«ğŸ’º Airplane",
            "ğŸ¦ğŸ’° Bank",
            "ğŸ›³ğŸŒŠ Cruise Ship",
            "âš½ï¸ğŸŸ Football Stadium",
            "ğŸªğŸ›’ Grocery Store",
            "ğŸ¥ğŸ§‘â€âš•ï¸ Hospital",
            "ğŸ¨ğŸ› Hotel",
            "ğŸğŸ¿ Cinema",
            "ğŸ›ğŸ–¼ Museum",
            "ğŸ¤ğŸ“® Post Office",
            "ğŸ½ğŸ‘©â€ğŸ³ Restaurant",
            "ğŸŸğŸ¸ Rock Concert",
            "ğŸš„ğŸ›¤ Train",
            "ğŸ«ğŸ“ University",
        ];

        validations = ["ğŸ˜€",
            "â­ï¸",
            "ğŸª",
            "ğŸ•",
            "ğŸ“",
            "ğŸ¥",
            "ğŸ©",
            "ğŸ¦",
            "âš½ï¸",
            "ğŸ·",
            "ğŸ§©",
            "ğŸ”‘",
            "ğŸ¶",
            "ğŸ¦œ",
            "ğŸµ",
            "ğŸ¬"]

        function startGame() {
            resetErrors();

            /* Get the Game params */
            var seed = document.getElementById("seed").value.toUpperCase();
            var iterationField = document.getElementById("iteration");
            var player = document.getElementById("player").value;
            var totalPlayers = document.getElementById("total-players").value;

            /* Validate the params */
            while (seed.length < 4) {
                seed += "A";
            }
            if (player > totalPlayers) {
                var errorBox = document.getElementById("error");
                errorBox.innerHTML = "ğŸ‘¤ > ğŸ‘¥ - Player # greater than total number of players"
                errorBox.style.display = "block";
                return;
            }

            /* Generate randomness */
            var randomNumber = getRNG(seed, iterationField.value, totalPlayers);
            var signature = getValidation(randomNumber);
            var isSpy = isPsy(randomNumber, player, totalPlayers);
            var firstPlayer = getFirstPlayer(randomNumber, player, totalPlayers);

            var locationName = "â“";
            if (!isSpy) {
                locationName = getLocation(randomNumber);
                document.getElementById("spyBlock").style.display = "none";
                document.getElementById("innocentBlock").style.display = "block";
            } else {
                document.getElementById("spyBlock").style.display = "block";
                document.getElementById("innocentBlock").style.display = "none";
            }


            /* Setup the Game Window */
            document.getElementById("signature").innerHTML = signature;
            document.getElementById("playerid").innerHTML = player;
            document.getElementById("location").innerHTML = locationName;
            document.getElementById("firstPlayer").innerHTML = '#' + firstPlayer;
            iterationField.value = iterationField.value * 1 + 1;

            document.getElementById("secretBlock").style.display = "block"
            document.getElementById("gameWindow").style.display = "inline-block";
        }

        function resetErrors() {
            var errorBox = document.getElementById("error");
            errorBox.style.display = "none";
            errorBox.innerHTML = "";
        }

        function getRNG(seed, iteration, totalPlayers) {
            var startDate = 0;
            for (let i = 0; i < seed.length; i++) {
                var charCode = seed.charCodeAt(i) + iteration + totalPlayers;
                startDate += charCode * (3 ** i);
            }

            var modulo = 65536;
            startDate %= modulo;
            var lfsr = startDate;
            var period = 0;

            do {
                lfsr ^= lfsr >> 7;
                lfsr ^= lfsr << 9;
                lfsr ^= lfsr >> 13;
                ++period;

                if (period > 1000000000) {
                    break;
                }
            }
            while ((lfsr % modulo) != startDate);

            return period;
        }

        function getValidation(seed) {
            var seed1 = seed;
            var seed2 = seed ^ (seed1 >> 1);
            var seed3 = seed ^ (seed2 >> 1);
            return validations[seed1 % validations.length] + validations[seed2 % validations.length] + validations[seed3 % validations.length];
        }

        function getLocation(seedNumber) {
            return locationsList[seedNumber % locationsList.length];
        }

        function isPsy(seedNumber, playerId, totalPlayers) {
            var spy = (seedNumber % totalPlayers) + 1;
            return playerId == spy;
        }

        function getFirstPlayer(seedNumber, playerId, totalPlayers) {
            return ((seedNumber >> 1) % totalPlayers) + 1;
        }

        function showHide(elementId) {
            var elem = document.getElementById(elementId);
            if (elem.style.display === 'none') {
                elem.style.display = 'block';
            } else {
                elem.style.display = 'none';
            }
        }

    </script>
</head>

<body>

    <h1>Offline Spy</h1>

    <div id="error" class="alert" style="display: none;"></div>

    <div id="gameWindow" class="card" style="display: none;">
        <div>
            Signature <span id="signature"></span>
        </div>
        <br>
        <div>
            ğŸ‘¤ Player <strong>#<span id="playerid"></span></strong>
        </div>
        <br>
        <div>
            ğŸ” First question: <strong id="firstPlayer"></strong>
        </div>
        <br>
        <div>
            <button class="button" onclick="showHide('secretBlock');">ğŸ‘“ Show/Hide</button>
        </div>
        <div id="secretBlock">
            <div id="spyBlock">
                You <strong>are</strong> the spy ğŸ•µ
            </div>
            <div id="innocentBlock">
                You are <strong>not</strong> the spy ğŸ˜‡
            </div>
            <div>
                Location: <span id="location"></span>
            </div>
        </div>
    </div>

    <br>

    <div id="settings" class="card">
        <div><strong>âš™ï¸ Settings</strong></div>
        <br>
        <label>ğŸ² Seed</label>&nbsp;<input id="seed" value="ABCD"><br>
        <label>ğŸ”¢ Iteration</label>&nbsp;<input type="number" id="iteration" value="1" min="1">
        <br>
        <label>ğŸ‘¥ Total players</label>&nbsp;<input type="number" id="total-players" value="3" min="3">
        <br>
        <br>
        <label>ğŸ‘¤ Player #</label>&nbsp;<input type="number" id="player" value="1" min="1">
        <br>
        <button onclick="startGame();" class="button">ğŸ Start New Game</button>
    </div>

    <br>

    <div class="card">
        <strong>Locations</strong>
        <ul id="locationsList" class="list">
        </ul>
    </div>

    <hr>

    <div class="footer">
        <div><a href="https://github.com/VeryBadFrags/offline-spy" target="_blank" rel="noopener noreferrer">Source
                code</a></div>
        <div>Version: 0.1.1</div>
    </div>

    <script>
        /* Init seed */
        var characters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
        var charactersLength = characters.length;
        var newSeed = "";
        for (var i = 0; i < 4; i++) {
            newSeed += characters.charAt(Math.floor(Math.random() * charactersLength));
        }
        document.getElementById("seed").value = newSeed;

        /* Show the list of Locations */
        var locationsListElement = document.getElementById("locationsList");
        for (var i = 0; i < locationsList.length; i++) {
            var locationName = locationsList[i];
            var li = document.createElement("li");
            li.innerHTML = locationName;
            locationsListElement.appendChild(li);
        }
    </script>

</body>

</html>
